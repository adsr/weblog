<!DOCTYPE html>
<html lang="en-us">

    <head>
    <title>monome part bi</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="https://blog.jfo.click/images/jeff.ico" type="image/x-icon" />
    <style type="text/css">
        @font-face {
    font-family: "etbook";
    src: url("https://blog.jfo.click/css/et-book.woff") format('woff');
}


    </style>
    <link rel="stylesheet" href="https://blog.jfo.click/css/style.css">
    <link rel="stylesheet" href="https://blog.jfo.click/css/solarized-dark.css">
    <link href="" rel="alternate feed" type="application/rss+xml" title="RSS Feed for blog.jfo.click" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
         m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-77907408-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>


    <body>
        <div id="content">
            <header class="site-header">
    <a href="https://blog.jfo.click/"><h4>archive</h4></a> &mdash;
    <a href="https://blog.jfo.click/about"><h4>about</h4></a> &mdash;
    <a href="https://blog.jfo.click/feed.xml"><h4>rss</h4></a>
</header>

            <article>
                <h1>monome part bi</h1>
                <sub>May 16, 2015 </sub>
                <div>
                    <p>In the last post I talked about figuring out what signals are coming from the monome when I press buttons. The obvious next goal is to find out what signals I can send <em>to</em> the monome.</p>

<p>I&rsquo;d like to say I reverse engineered this bit, too, but I&rsquo;d be lying. I assumed it would follow a similar pattern of 3 bytes per signal- x and y coordinates and an on or off byte, in some kind of order or another, but I didn&rsquo;t want to start guessing. To check my intuition, I instead turned to the <a href="http://monome.org/docs/tech:serial">protocol itself</a>. I was right, for the most part.</p>

<p>The document linked to above, I suppose, is pretty comprehensive. It details the <a href="http://opensoundcontrol.org/introduction-osc">OSC</a> grammar in addition to the bare byte serial one I was looking for. OSC seems really robust and awesome, and I imagine when I actually start writing useful things for the monome it will be using that, but I don&rsquo;t know anything about it yet.</p>

<p>Around line 30 or so, under &ldquo;led-grid&rdquo;, I found what I was looking for. There are a lot of options for setting the leds to &lsquo;on&rsquo; and &lsquo;off&rsquo;, mostly in terms of groupings. Though I am most interested in controlling one light at a time, one option did catch my eye&hellip; to control all the lights at one time, you only have to send a single byte! <code>\x13</code> for on or <code>\x12</code> for off. Cool!</p>

<p>I&rsquo;ve already established that it&rsquo;s pretty easy to send data to the device by writing directly to the file that shows up in <code>/dev/</code>, so let&rsquo;s try that. bash represents hex like <code>\x..</code> where &ldquo;.&rdquo; is some digit <code>0-f</code>. How about&hellip;</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">echo</span> <span class="s2">&quot;\x13&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>Hey, this worked! The whole grid lights up!</p>

<p><img src="https://igcdn-photos-b-a.akamaihd.net/hphotos-ak-xaf1/t51.2885-15/11271045_1648449182043465_1140557603_n.jpg" alt="A lit up monome" /></p>

<p>Now I&rsquo;ll try to turn it off</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">echo</span> <span class="s2">&quot;\x12&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>Hmm. Nothing. It just sits there, brightly mocking me. Oh and when I unplug it and plug it back in to reset, sometimes it crashes my computer, so that&rsquo;s not great. Turns out <code>echo</code> appends a newline character (&rdquo;\n&rdquo;) to whatever you pass to it (for completely reasonable reasons, I&rsquo;m sure), so I was actually sending <em>two</em> bytes to the monome, the latter of which it didn&rsquo;t know what to do with. A <code>-n</code> flag will remove that newline:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">echo</span> -n <span class="s2">&quot;\x12&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>Or, alternately, <code>printf</code> doesn&rsquo;t append a newline at all:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">printf</span> <span class="s2">&quot;\x12&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>Really, anything that gets those bytes into standard out will work just fine, there are probably a bunch of other utilities that do this in some capacity.</p>

<p>According to the protocol, if I want to control individual leds, I send a <em>different</em> on or off byte (&rdquo;\x11&rdquo; and &ldquo;\x10&rdquo;, respectively) followed by the x and y coordinates of the button I&rsquo;m targeting. So, if I want to turn on the first led:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">echo</span> -n <span class="s2">&quot;\x11\x00\x00&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>or turn it off:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">echo</span> -n <span class="s2">&quot;\x10\x00\x00&quot;</span> &gt; dev/tty.usbserial-m1000065
</code></pre></div>

<p>Now that I have a basic vocabulary with which to communicate in both directions with the device, I&rsquo;m ready to write my first &ldquo;application&rdquo; for it. It&rsquo;s going to be so cutting edge, y&rsquo;all, like when I push a button the light is going to come on, and when I release the button, the light is going to go off it&rsquo;s going to be so awesome oh wow.</p>

<p>Because we&rsquo;re talking over serial here, any language with a serial protocol library (so I guess all of them, right?) can be used. Here&rsquo;s &ldquo;turn all the lights on, then wait a second, then turn all the lights off&rdquo; in Ruby&hellip;</p>

<p>First I&rsquo;ll set up the port object (that I&rsquo;ll be using for the rest of the post)</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="nb">require</span> <span class="s1">&#39;serialport&#39;</span>
<span class="n">ser</span> <span class="o">=</span> <span class="no">SerialPort</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;/dev/tty.usbserial-m1000065&quot;</span><span class="p">,</span> <span class="mi">9600</span><span class="p">)</span>
</code></pre></div>

<p><a href="https://rubygems.org/gems/serialport/versions/1.3.1">Serialport</a> is a serial comm library, as you might have been able to guess. The <code>9600</code> being passed into the object initializer is the <a href="http://en.wikipedia.org/wiki/Baud">baud rate declaration</a> for that now open port. <code>9600</code> is plenty fast for this right now.</p>

<p>Then write the bytes to the port:</p>

<p><code>&lt;blink&gt;</code>!</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x13</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">sleep</span> <span class="mi">1</span>
<span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x12</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><code>&lt;/blink&gt;</code>!</p>

<p>Basically, I want to write a server that listens to this port and responds to signals with an instruction to do a thing based on that signal. The server is an open ear, patiently running on a loop until it hears something that it knows what to do with.</p>

<p>There are various methods and ways to get data into the program, but for now I&rsquo;m going to use the Serialport class&rsquo;s <code>getc</code> method, which attempts to read just one character from the stream. (This is a method of Ruby&rsquo;s <code>IO</code> class, which is <code>SerialPort</code>&rsquo;s direct parent).</p>

<p>Here is a loop that prints the input to the screen:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="kp">loop</span> <span class="k">do</span>
    <span class="nb">print</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span>
<span class="k">end</span>
</code></pre></div>

<p>And it&rsquo;s our old friend &ldquo;!&rdquo;! This little program, by the way, acts exactly like <code>cat</code>ting the device file from the prompt. I&rsquo;ve a little more facility in this context, though, so lets get it to print something that makes sense. This is just a matter of formatting&hellip; how about the hex values, since that&rsquo;s what we&rsquo;ve been looking at thus far?</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="kp">loop</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span><span class="o">.</span><span class="n">ord</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>

<p><code>ord</code> converts the input to its bitwise numerical value (in decimal) and <code>to_s(16)</code> changes the type from a decimal int to a string representing the value of the int you&rsquo;ve called it on in the base of the arg you pass to it.</p>

<p>I know, this one is pretty confusing, but:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="mi">7</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 7</span>
<span class="mi">8</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 8</span>
<span class="mi">9</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 9</span>
<span class="mi">10</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># a</span>
<span class="mi">11</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># b</span>
<span class="mi">12</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># c</span>
<span class="mi">13</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># d</span>
<span class="mi">14</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># e</span>
<span class="mi">15</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># f</span>
<span class="mi">16</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 10</span>
<span class="mi">17</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 11</span>
<span class="mi">18</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 12</span>
<span class="mi">19</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># 13</span>
</code></pre></div>

<p>etc&hellip; or</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="mi">7</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 111</span>
<span class="mi">8</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1000</span>
<span class="mi">9</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1001</span>
<span class="mi">10</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1010</span>
<span class="mi">11</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1011</span>
<span class="mi">12</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1100</span>
<span class="mi">13</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1101</span>
<span class="mi">14</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1110</span>
<span class="mi">15</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 1111</span>
<span class="mi">16</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 10000</span>
<span class="mi">17</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 10001</span>
<span class="mi">18</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 10010</span>
<span class="mi">19</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 10011</span>
</code></pre></div>

<p>Step last is simply to respond to a button press with a signal to turn that button&rsquo;s light on, and a button release to turn that button&rsquo;s light off.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="kp">loop</span> <span class="k">do</span>
    <span class="n">thinger</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span><span class="p">()</span><span class="o">.</span><span class="n">ord</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">thinger</span> <span class="o">==</span> <span class="s2">&quot;21&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span>
        <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x11</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">thinger</span> <span class="o">==</span> <span class="s2">&quot;20&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">getc</span>
        <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x10</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

<p>And it pretty much does what I wanted now! Except, it misses a lot of events, and if you press or release a lot of buttons at one time, it will miss a lot of those as well, but this is most probably a consequence of the single threadedness of the above loop, and the fact that the signal from a button press could be lost while the program is executing other code besides the primary loop&hellip;</p>

<p>There are a lot of problems with this model, actually, but they are problems that have no doubt been dealt with and optimized in the standard and/or mostly-in-use IO libraries for the monome, like <a href="https://github.com/monome/libmonome">libmonome</a> which I&rsquo;ll probably be switching over to now that I kind of feel like I get the gist of how this protocol works. This was fun to figure out though.</p>

<p><code>&lt;blink&gt;&lt;/blink&gt;</code>!</p>

                </div>
            </article>
        </div>
    </body>
</html>
