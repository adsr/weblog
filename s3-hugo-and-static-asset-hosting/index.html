<!DOCTYPE html>
<html lang="en-us">

    <head>
    <title>s3, Hugo, and static asset hosting</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="https://blog.jfo.click/images/jeff.ico" type="image/x-icon" />
    <style type="text/css">
        @font-face {
    font-family: "etbook";
    src: url("https://blog.jfo.click/css/et-book.woff") format('woff');
}


    </style>
    <link rel="stylesheet" href="https://blog.jfo.click/css/style.css">
    <link href="" rel="alternate feed" type="application/rss+xml" title="RSS Feed for blog.jfo.click" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
         m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-77907408-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>


    <body>
        <div id="content">
            <header class="site-header">
    <a href="https://blog.jfo.click/"><h4>archive</h4></a> &mdash;
    <a href="https://blog.jfo.click/about"><h4>about</h4></a> &mdash;
    <a href="https://blog.jfo.click/feed.xml"><h4>rss</h4></a>
</header>

            <article>
                <p>
                    <h1>s3, Hugo, and static asset hosting</h1>
                    <sub>September 29, 2017 </sub>
                <p>
                <div>
                    

<p>I&rsquo;ve been writing this blog for a while now, and put it through several different
blogging engines and style changes.  <a href="https://wordpress.org/">Wordpress</a>,
<a href="https://middlemanapp.com/">Middleman</a>, <a href="https://jekyllrb.com/">Jekyll</a>&hellip;  and
finally to <a href="https://gohugo.io/">Hugo</a>, which I&rsquo;m using currently. I feel it
should be <em>really easy</em> to switch platforms (where &ldquo;really easy&rdquo; means like, a
week or two of fiddly work), and I fully expect to do so again when it becomes
worth the trouble to do it, whenever and whyever that may be.</p>

<p>I was hosting my Middleman version on <a href="https://pages.github.com/">github
pages</a>, but Jekyll was attractive with the built in
<a href="https://help.github.com/articles/about-github-pages-and-jekyll/">build
support</a>, so I
switched to that when Middleman made some breaking changes.  It was great in
every way except that it was simply <em>way</em> too slow! I have around
80 posts so far, and I&rsquo;m only going to write more, but it took about 5 or 6
seconds for every build, even with incremental builds on! Most of this was
likely due to the syntax highlighting, and usually it wouldn&rsquo;t be that big a
deal, but when I was writing interactive javascript snippets like for <a href="/the-mandelwat-set/">&ldquo;The
Mandelwat Set&rdquo;</a> it <em>really</em> slowed me down. I decided to
switch to something faster.</p>

<p>The spectre of &ldquo;write your own&rdquo; is always looming, but I also truly want to
simply have a tool that makes things easy, stays out of my way, and &ldquo;just
works.&rdquo; Hugo has everything I need!  It&rsquo;s <em>super fast</em>.  After the initial
build every incremental change triggers a new build that takes about 150
milliseconds. It also includes a development server that auto reloads on every
build.</p>

<p>This is all great! But there is something I&rsquo;ve been thinking about for quite a
while that I need, and that is photo hosting! I want to to be able to spice up
my posts with custom images, but I don&rsquo;t want to commit images to my git
repo - both to avoid bloat and because, properly speaking, image files are
data, not source code. I know this is fairly arbitrary, but I feel oddly
strongly about maintaining that separation.</p>

<p>For The Mandelwat set, I uploaded small photos to <a href="https://imgur.com/">imgur</a>.
This works great, but it&rsquo;s very time consuming, and results in ugly URL&rsquo;s like
<a href="https://i.imgur.com/Yq0SFWn.jpg">https://i.imgur.com/Yq0SFWn.jpg</a>. Not to mention, and most importantly for
posterity&rsquo;s sake, it&rsquo;s all dependant on their naming scheme and continued
existence. I want this site to be as self contained as possible and where not,
relatively reproducible. If Hugo disappeared tomorrow, I know that I could
switch to another static site generator (albeit with some effort). If they all
disappeared, I know that I could write my own static site generator (albeit
with much more effort). If html is disappeared and some new weird markup format
comes out, I know I could get <em>this</em> markdown into that format <em>somehow</em> (probably with <a href="http://pandoc.org/">pandoc</a>).</p>

<p>The point is not that I expect this site to necessarily last for that long, the
point is that I&rsquo;d like to operate with the assumption that it <em>could</em>.  Bitrot
is real! Great swaths of the foundational internet has withered into the ether!
Remember <a href="https://news.ycombinator.com/item?id=4136682">Geocities</a>?</p>

<p>Anyway, I want a place to host images that&rsquo;s not in my source tree and is easy
to manage.</p>

<p>I went to an <a href="https://aws.amazon.com/events/awsomeday-nordics-2017/">AWS conference last
week</a>, and guess what
will solve my problem? <a href="https://aws.amazon.com/s3/">S3</a>!</p>

<h2 id="here-s-how-i-set-it-up">Here&rsquo;s how I set it up.</h2>

<p>I started with a <code>.gitignore</code>d folder in the root of my blog&rsquo;s directory: <code>s3</code>.</p>

<p>I installed and authenticated the <a href="https://aws.amazon.com/cli/">command line interface
<code>awscli</code></a> with homebrew:</p>

<pre><code>$ brew install awscli
</code></pre>

<p>&hellip; and
<a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html#cli-quick-configuration">configured</a>
it with</p>

<pre><code>$ aws configure
</code></pre>

<p>I created a bucket on <code>s3</code> just for this purpose called <code>blog.jfo.click</code>, and I
added some <code>make</code> targets that sync both to the bucket:</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">syncs3</span><span class="o">:</span>
	aws s3 sync ./s3 s3://blog.jfo.click/
</code></pre></div>

<p>and from the bucket:</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">syncfroms3</span><span class="o">:</span>
	aws s3 sync s3://blog.jfo.click/ ./s3
</code></pre></div>

<p>Since I am in there, I also took care of a <code>TODO</code> I&rsquo;ve been meaning to do to
make it easier to deploy my whole site with a single command.</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">push</span><span class="o">:</span> <span class="n">build</span>
	<span class="nb">cd</span> ./public <span class="o">&amp;&amp;</span> git add -A <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;`date`&quot;</span> <span class="o">&amp;&amp;</span> git push

<span class="nf">build</span><span class="o">:</span>
	hugo
</code></pre></div>

<p><code>build</code> simply issues the <code>hugo</code> command to build the site. <code>push</code> now <code>cd</code>&rsquo;s
into the built directory, adds and commits everything indiscriminantly, and
pushes it to <em>its</em> remote, which is a <a href="https://dev.to/letsbsocial1/deploying-to-gh-pages-with-git-subtre://dev.to/letsbsocial1/deploying-to-gh-pages-with-git-subtree">git
subtree</a></p>

<p>Finally,</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">deploy</span><span class="o">:</span> <span class="n">syncs</span>3 <span class="n">push</span>
</code></pre></div>

<p>Now, with a single <code>make deploy</code>, I can sync my images, build the site, and
push it all up to the hosted environment. This is a lot better than the multi
step process I was doing before, <em>and</em> adds the images!</p>

<p>Ok, last thing. Hosting static content on s3 has a lot of benefits&hellip; it&rsquo;s
easy, scriptable via the command line interface, cheap, and automagically
CDN&rsquo;d. But it also results in ugly URLs like this:</p>

<pre><code>https://s3-us-west-2.amazonaws.com/blog.jfo.click/images/redefine.jpg
</code></pre>

<p>This is not good for two reasons. I don&rsquo;t want to be typing that into every
place I post a photo, certainly, but more importantly I want to be able to
replicate my full image folder in an arbitrary place and switch every reference
across my site to it without editing every file. Let&rsquo;s say that tomorrow,
Amazon goes out of business. I know, lol right? But <a href="https://www.theatlantic.com/business/archive/2017/09/sears-predicts-amazon/540888/">who knows what will happen
in the future</a>.
Perhaps more realistically in the short term, they could render s3 unusable
because of price or breaking API changes&hellip; or they could deprecate it. Who
knows! I would like to know that if I have to or want to for any reason, I
could host my photos and other static assets anywhere else at a moment&rsquo;s
notice.</p>

<p>Hugo has a great feature I can use for this,
<a href="https://gohugo.io/content-management/shortcodes/">shortcodes</a>!</p>

<p>I make a template for my simple little shortcode here:</p>

<pre><code>/themes/jfo/shortcodes/img.html
</code></pre>

<p>That consists of a single, simple line:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://s3-us-west-2.amazonaws.com/blog.jfo.click/images/{{ .Get 0 }}&quot;</span> <span class="p">/&gt;</span>
</code></pre></div>

<p>You&rsquo;ll notice an interpolated variable here, or at least a method that looks
like it is accessing same:</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="p">{{</span> <span class="p">.</span><span class="nx">Get</span> <span class="mi">0</span> <span class="p">}}</span>
</code></pre></div>

<p>This is how I access things I pass in!</p>

<p>I can now put a shortcode tag anywhere in my markdown passing in a filename as
a string of something I&rsquo;ve stored in that I&rsquo;ve stored in the synced <code>s3</code> folder:</p>

<pre>{&#8205;{< img "redefine.jpg" >}}</pre>

<blockquote>
<p>Hey also fun fact, I had to use a hidden <a href="https://en.wikipedia.org/wiki/Zero-width_joiner">zero width
joiner</a> in my markup to
actually type that and not have it be preprocessed. Looks like:</p>

<pre><code>{&amp;#8205;{&lt; img &quot;redefine.jpg&quot; &gt;}}
</code></pre>

<p>!</p>
</blockquote>

<p>That, by the way, is the new version of the <a href="/v-i">very first post I made</a> on
my OG site that was Wordpress.</p>

<p>So! Expect to see more media on here in the future!</p>

                </div>
            </article>
        </div>
    </body>
</html>
